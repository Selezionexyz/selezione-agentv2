<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Selezione Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
.header{background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);padding:20px;border-bottom:1px solid #334155;position:sticky;top:0;z-index:100}
.header h1{font-size:1.5rem;background:linear-gradient(135deg,#f59e0b,#eab308);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700}
.header p{color:#94a3b8;font-size:0.85rem;margin-top:4px}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px}
.stat{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);border-radius:16px;padding:16px;text-align:center;border:1px solid #475569}
.stat-value{font-size:1.8rem;font-weight:700;color:#f59e0b}
.stat-label{font-size:0.75rem;color:#94a3b8;margin-top:4px;text-transform:uppercase}
.tabs{display:flex;padding:0 16px;gap:8px;margin-top:8px}
.tab{flex:1;padding:12px;background:#1e293b;border:none;color:#94a3b8;border-radius:12px;font-size:0.9rem;cursor:pointer}
.tab.active{background:linear-gradient(135deg,#f59e0b,#d97706);color:#0f172a;font-weight:600}
.chat_history{padding:16px;display:flex;flex-direction:column;gap:12px}
.conv-card{background:#1e293b;border-radius:16px;padding:16px;border:1px solid #334155;cursor:pointer}
.conv-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.conv-phone{font-weight:600;color:#f8fafc}
.conv-time{font-size:0.75rem;color:#64748b}
.conv-preview{color:#94a3b8;font-size:0.9rem;overflow:hidden;text-overflow:ellipsis}
.conv-meta{display:flex;gap:8px;margin-top:8px}
.conv-tag{background:#334155;padding:4px 8px;border-radius:8px;font-size:0.7rem;color:#cbd5e1}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:200;padding:20px}
.modal.active{display:block}
.modal-content{background:#1e293b;border-radius:16px;max-height:90vh;overflow-y:auto}
.modal-header{padding:16px;border-bottom:1px solid #334155;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#1e293b}
.close-btn{background:#f59e0b;border:none;color:#0f172a;width:32px;height:32px;border-radius:50%;font-size:1.2rem;cursor:pointer}
.messages{padding:16px;display:flex;flex-direction:column;gap:12px}
.msg{max-width:85%;padding:12px 16px;border-radius:16px;font-size:0.95rem}
.msg.user{background:#334155;color:#f8fafc;align-self:flex-start}
.msg.assistant{background:linear-gradient(135deg,#f59e0b,#d97706);color:#0f172a;align-self:flex-end}
.msg-label{font-size:0.7rem;opacity:0.7;margin-top:4px}
.loader{display:flex;justify-content:center;padding:40px}
.loader::after{content:"";width:40px;height:40px;border:3px solid #334155;border-top-color:#f59e0b;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.refresh-btn{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:#0f172a;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 20px rgba(245,158,11,0.4)}
</style>
</head>
<body>
<div class="header"><h1>üèÜ Selezione Dashboard</h1><p>Agent WhatsApp Intelligent</p></div>
<div class="stats">
<div class="stat"><div class="stat-value" id="stat-clients">-</div><div class="stat-label">Clients</div></div>
<div class="stat"><div class="stat-value" id="stat-messages">-</div><div class="stat-label">Messages</div></div>
<div class="stat"><div class="stat-value" id="stat-today">-</div><div class="stat-label">Aujourd'hui</div></div>
</div>
<div class="tabs"><button class="tab active" onclick="filterConvs('all')">Tous</button><button class="tab" onclick="filterConvs('today')">Aujourd'hui</button></div>
<div id="chat_history" class="chat_history"><div class="loader"></div></div>
<div id="modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="modal-title">Conversation</h2><button class="close-btn" onclick="closeModal()">√ó</button></div><div id="modal-messages" class="messages"></div></div></div>
<button class="refresh-btn" onclick="loadData()">üîÑ</button>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const{createClient}=supabase;const db=createClient('https://illosocrmbioyefvqjae.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsbG9zb2NybWJpb3llZnZxamFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NjE3MzEsImV4cCI6MjA4MzEzNzczMX0.am2EdH7HsEbl4P8sygUS14_RWuBoOVCg4kaECfG6G70');let allConvs=[];
async function loadData(){document.getElementById('chat_history').innerHTML='<div class="loader"></div>';const{data}=await db.from('chat_history').select('*').order('updated_at',{ascending:false});allConvs=data||[];const totalMsgs=allConvs.reduce((a,c)=>a+(c.messages?.length||0),0);const today=allConvs.filter(c=>new Date(c.updated_at).toDateString()===new Date().toDateString()).length;document.getElementById('stat-clients').textContent=allConvs.length;document.getElementById('stat-messages').textContent=totalMsgs;document.getElementById('stat-today').textContent=today;renderConvs(allConvs);}
function renderConvs(convs){const container=document.getElementById('chat_history');if(convs.length===0){container.innerHTML='<div style="text-align:center;padding:60px;color:#64748b">üì≠ Aucune conversation</div>';return;}container.innerHTML=convs.map(c=>'<div class="conv-card" onclick="openConv(\''+c.phone+'\')"><div class="conv-header"><span class="conv-phone">'+formatPhone(c.phone)+'</span><span class="conv-time">'+formatTime(c.updated_at)+'</span></div><div class="conv-preview">'+getLastMsg(c)+'</div><div class="conv-meta"><span class="conv-tag">üí¨ '+(c.messages?.length||0)+'</span></div></div>').join('');}
function formatPhone(p){return p?.replace('whatsapp:','').replace(/(\+33)(\d)(\d{2})(\d{2})(\d{2})(\d{2})/,'$1 $2 $3 $4 $5 $6')||'Inconnu';}
function formatTime(t){const d=new Date(t);const now=new Date();if(d.toDateString()===now.toDateString())return d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});return d.toLocaleDateString('fr-FR',{day:'numeric',month:'short'});}
function getLastMsg(c){return c.messages?.[c.messages.length-1]?.content?.substring(0,50)||'Pas de message';}
function filterConvs(type){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));event.target.classList.add('active');if(type==='today'){renderConvs(allConvs.filter(c=>new Date(c.updated_at).toDateString()===new Date().toDateString()));}else{renderConvs(allConvs);}}
function openConv(phone){const conv=allConvs.find(c=>c.phone===phone);if(!conv)return;document.getElementById('modal-title').textContent=formatPhone(phone);document.getElementById('modal-messages').innerHTML=(conv.messages||[]).map(m=>'<div class="msg '+m.role+'">'+m.content+'<div class="msg-label">'+(m.role==='user'?'Client':'Selezione IA')+'</div></div>').join('');document.getElementById('modal').classList.add('active');}
function closeModal(){document.getElementById('modal').classList.remove('active');}
loadData();db.channel('changes').on('postgres_changes',{event:'*',schema:'public',table:'chat_history'},()=>loadData()).subscribe();
</script>
</body>
</html>
